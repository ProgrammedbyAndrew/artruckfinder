<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>North Arrow Compass Demo</title>
<style>
  body, html {
    margin: 0;
    padding: 0;
    overflow: hidden;
    background: #000;
  }

  #videoElement {
    position: absolute;
    top: 0; left: 0;
    width: 100vw; height: 100vh;
    object-fit: cover;
    z-index: 1;
  }

  #threeContainer {
    position: absolute;
    top: 0; left: 0;
    width: 100vw; height: 100vh;
    z-index: 2;
    pointer-events: none;
  }

  #debugConsole {
    position: absolute;
    top: 10px; right: 10px;
    width: 40vw; 
    max-height: 30vh;
    overflow-y: auto;
    background: rgba(0,0,0,0.8);
    color: #0f0;
    font-size: 12px;
    line-height: 1.2em;
    padding: 5px;
    z-index: 999;
    border: 1px solid #0f0;
    font-family: monospace;
  }

  #enableOrientationBtn {
    position: absolute;
    top: 10px; left: 10px;
    z-index: 1000;
    background: #222;
    color: #fff;
    border: 1px solid #0f0;
    font-size: 14px;
    padding: 5px;
    cursor: pointer;
  }

</style>
</head>
<body>

<video id="videoElement" autoplay playsinline></video>
<div id="threeContainer"></div>
<div id="debugConsole">Debug console initialized...</div>
<button id="enableOrientationBtn" style="display:none;">Enable Orientation</button>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r127/three.min.js"></script>

<script>
// Debug console setup
let logs = [];
(function() {
  const debugEl = document.getElementById('debugConsole');

  function appendMessage(type, ...args) {
    const msg = args.map(a => (typeof a === 'object' ? JSON.stringify(a) : String(a))).join(' ');
    const line = document.createElement('div');
    line.textContent = `[${type.toUpperCase()}] ${msg}`;
    debugEl.appendChild(line);
    debugEl.scrollTop = debugEl.scrollHeight;
    logs.push(`${type.toUpperCase()} ${msg}`);
  }

  const origLog = console.log;
  console.log = (...args) => { origLog(...args); appendMessage('log', ...args); };
  console.error = (...args) => { origLog(...args); appendMessage('error', ...args); };
  console.warn = (...args) => { origLog(...args); appendMessage('warn', ...args); };

  console.log("Debug console active.");
})();

let orientationEnabled = false;
const enableOrientationBtn = document.getElementById('enableOrientationBtn');

// Orientation permission (iOS)
if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
  enableOrientationBtn.style.display = 'block';
  enableOrientationBtn.addEventListener('click', async () => {
    const permissionState = await DeviceOrientationEvent.requestPermission();
    if (permissionState === 'granted') {
      console.log("DeviceOrientation permission granted.");
      orientationEnabled = true;
      enableOrientationBtn.style.display = 'none';
      enableOrientationListening();
    } else {
      console.warn("DeviceOrientation permission denied.");
    }
  });
} else {
  orientationEnabled = true;
  enableOrientationListening();
}

let deviceHeading = 0;
function enableOrientationListening() {
  if (!orientationEnabled) return;
  window.addEventListener('deviceorientation', (event) => {
    deviceHeading = event.alpha;
    console.log(`Orientation event: alpha=${event.alpha.toFixed(2)}°, deviceHeading=${deviceHeading.toFixed(2)}°`);
    updateArrowRotation();
  }, true);
  console.log("DeviceOrientation listening started.");
}

// Just a helper
function toRadians(deg) {
  return deg * Math.PI / 180;
}

// Set up camera
(async function init() {
  console.log("Requesting camera access...");
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ 
      video: { facingMode: "environment" }, 
      audio: false 
    });
    const video = document.getElementById('videoElement');
    video.srcObject = stream;
    await new Promise(resolve => video.onloadedmetadata = resolve);
    console.log("Camera loaded successfully.");
  } catch (err) {
    console.error("Error accessing camera:", err);
    return;
  }

  setupThreeJS();
})();

let scene, camera, renderer, arrowGroup;

function setupThreeJS() {
  const container = document.getElementById('threeContainer');
  scene = new THREE.Scene();

  camera = new THREE.PerspectiveCamera(70, container.clientWidth / container.clientHeight, 0.1, 1000);
  camera.position.set(0,0,0);

  renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
  renderer.setSize(container.clientWidth, container.clientHeight);
  renderer.setClearColor(0x000000, 0);
  container.appendChild(renderer.domElement);

  createArrow();
  animate();

  console.log("3D scene set up complete. Arrow should point north (no matter device rotation).");
}

function createArrow() {
  arrowGroup = new THREE.Group();

  // Shaft
  const shaftGeometry = new THREE.CylinderGeometry(0.05, 0.05, 2, 16);
  const shaftMaterial = new THREE.MeshBasicMaterial({ color: 0x00ff00 });
  const shaft = new THREE.Mesh(shaftGeometry, shaftMaterial);
  shaft.position.y = 1; 
  arrowGroup.add(shaft);

  // Head
  const headGeometry = new THREE.ConeGeometry(0.15, 0.5, 16);
  const headMaterial = new THREE.MeshBasicMaterial({ color: 0xff0000 });
  const head = new THREE.Mesh(headGeometry, headMaterial);
  head.position.y = 2.5;
  arrowGroup.add(head);

  // By default, cylinder and cone extend along Y axis.
  // We want it to point along -Z axis as "forward/north".
  arrowGroup.rotation.x = -Math.PI / 2;
  arrowGroup.position.z = -3;
  scene.add(arrowGroup);
}

function updateArrowRotation() {
  // Device heading: 0 = north, 90 = east, etc.
  // If device heading=0 (facing north), arrow no rotation needed since arrow points north.
  // If device heading=90 (facing east), rotate arrow -90 degrees so it still points north.
  const finalRotation = -toRadians(deviceHeading);
  arrowGroup.rotation.y = finalRotation;
}

function animate() {
  requestAnimationFrame(animate);
  renderer.render(scene, camera);
}
</script>
</body>
</html>