<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Navigational Arrow with Device Orientation</title>
    <style>
        body {
            margin: 0;
            font-family: sans-serif;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            background: #f0f0f0;
            align-items: center;
            justify-content: center;
        }

        .arrow-display {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
        }

        .arrow {
            font-size: 100px; 
            transition: transform 0.1s ease;
            margin-bottom: 10px;
        }

        .distance {
            font-size: 24px;
            background: #fff;
            padding: 10px 20px;
            border-radius: 5px;
            border: 1px solid #ccc;
            margin-bottom: 20px;
        }

        .debug-panel {
            font-size: 14px;
            background: #eee;
            padding: 10px;
            border-radius: 5px;
            width: 90%;
            max-width: 400px;
        }

        .debug-panel p {
            margin: 5px 0;
        }

        .debug-panel span {
            font-weight: bold;
        }

        .permission-button {
            margin-bottom: 20px;
            background: #007BFF;
            color: #fff;
            padding: 10px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
        }

        .permission-button:hover {
            background: #0056b3;
        }
    </style>
</head>
<body>

    <button class="permission-button" id="enable-orientation">Enable Orientation</button>

    <div class="arrow-display">
        <div class="arrow" id="arrow">↑</div>
        <div class="distance" id="distance">Calculating distance...</div>
    </div>

    <div class="debug-panel" id="debug-panel">
        <p>User Lat: <span id="user-lat">N/A</span></p>
        <p>User Lon: <span id="user-lon">N/A</span></p>
        <p>Target Lat: <span id="target-lat">28.334492</span></p>
        <p>Target Lon: <span id="target-lon">-81.517770</span></p>
        <p>Bearing to Target: <span id="bearing">N/A</span>°</p>
        <p>Device Heading: <span id="device-heading">N/A</span>°</p>
        <p>Final Arrow Rotation: <span id="arrow-rotation">N/A</span>°</p>
        <p>Distance: <span id="debug-distance">N/A</span> ft</p>
    </div>
    

    <script>
        const targetLat = 28.334492; 
        const targetLon = -81.517770; 

        let currentLat = null;
        let currentLon = null;
        let deviceHeading = 0; // This will represent the device's heading from North

        const arrow = document.getElementById('arrow');
        const distanceDiv = document.getElementById('distance');
        const enableOrientationButton = document.getElementById('enable-orientation');
        const debugPanel = {
            userLat: document.getElementById('user-lat'),
            userLon: document.getElementById('user-lon'),
            bearing: document.getElementById('bearing'),
            deviceHeading: document.getElementById('device-heading'),
            arrowRotation: document.getElementById('arrow-rotation'),
            debugDistance: document.getElementById('debug-distance')
        };

        function toRad(deg) {
            return deg * Math.PI / 180;
        }

        function haversineDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; // meters
            const φ1 = toRad(lat1);
            const φ2 = toRad(lat2);
            const Δφ = toRad(lat2 - lat1);
            const Δλ = toRad(lon2 - lon1);

            const a = Math.sin(Δφ / 2) ** 2 +
                      Math.cos(φ1) * Math.cos(φ2) *
                      Math.sin(Δλ / 2) ** 2;
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        function bearingToTarget(lat1, lon1, lat2, lon2) {
            const φ1 = toRad(lat1);
            const φ2 = toRad(lat2);
            const λ1 = toRad(lon1);
            const λ2 = toRad(lon2);

            const y = Math.sin(λ2 - λ1) * Math.cos(φ2);
            const x = Math.cos(φ1)*Math.sin(φ2) -
                      Math.sin(φ1)*Math.cos(φ2)*Math.cos(λ2 - λ1);
            const θ = Math.atan2(y, x);
            return (θ * 180 / Math.PI + 360) % 360; // in degrees
        }

        function updateDisplay() {
            if (currentLat == null || currentLon == null) {
                return; 
            }

            const bearing = bearingToTarget(currentLat, currentLon, targetLat, targetLon);
            const distanceMeters = haversineDistance(currentLat, currentLon, targetLat, targetLon);
            const distanceFeet = distanceMeters * 3.28084;

            // Rotation needed: bearing relative to North minus device heading
            let arrowRotation = (bearing - deviceHeading + 360) % 360;

            arrow.style.transform = `rotate(${arrowRotation}deg)`;
            distanceDiv.textContent = `${distanceFeet.toFixed(0)} ft away`;

            // Update debug
            debugPanel.userLat.textContent = currentLat.toFixed(5);
            debugPanel.userLon.textContent = currentLon.toFixed(5);
            debugPanel.bearing.textContent = bearing.toFixed(2);
            debugPanel.deviceHeading.textContent = deviceHeading.toFixed(2);
            debugPanel.arrowRotation.textContent = arrowRotation.toFixed(2);
            debugPanel.debugDistance.textContent = distanceFeet.toFixed(0);
        }

        // Geolocation
        if ('geolocation' in navigator) {
            navigator.geolocation.watchPosition(position => {
                currentLat = position.coords.latitude;
                currentLon = position.coords.longitude;
                updateDisplay();
            }, 
            error => {
                distanceDiv.textContent = "Unable to get location.";
                console.error("Geolocation error:", error);
            },
            {
                enableHighAccuracy: true
            });
        } else {
            distanceDiv.textContent = "Geolocation not supported.";
        }

        // Request permission for device orientation on iOS
        enableOrientationButton.addEventListener('click', () => {
            if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                DeviceOrientationEvent.requestPermission().then(response => {
                    if (response === 'granted') {
                        console.log("Device orientation permission granted.");
                        startDeviceOrientation();
                    } else {
                        console.log("Permission denied for device orientation.");
                    }
                }).catch(console.error);
            } else {
                // For devices that don't require permission
                startDeviceOrientation();
            }
        });

        function startDeviceOrientation() {
            window.addEventListener('deviceorientation', (e) => {
                console.log('Device Orientation Event:', {
                    alpha: e.alpha,
                    beta: e.beta,
                    gamma: e.gamma,
                    webkitCompassHeading: e.webkitCompassHeading,
                    absolute: e.absolute
                });

                if (typeof e.webkitCompassHeading === 'number') {
                    // iOS Safari provides a direct compass heading (0 = North)
                    deviceHeading = e.webkitCompassHeading;
                } else if (typeof e.alpha === 'number') {
                    // On other browsers, alpha is typically 0 = device facing East. 
                    // Convert so that 0 = North. North is 90 degrees from East.
                    // heading = (alpha + 90) % 360 makes alpha=0 -> 90deg which is North.
                    let heading = (e.alpha + 90) % 360;
                    deviceHeading = heading;
                }

                updateDisplay();
            });
        }
    </script>
</body>
</html>