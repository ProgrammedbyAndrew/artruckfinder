<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>AR Navigational Arrow</title>
    <style>
        html, body {
            margin: 0;
            font-family: sans-serif;
            overflow: hidden;
            height: 100%;
            background: #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #camera-stream {
            position: absolute;
            top: 0; left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: -2;
        }

        .overlay {
            position: absolute;
            top:0; left:0; right:0; bottom:0;
            background: rgba(0,0,0,0.8); /* 80% overlay, leaving about 20% camera visibility */
            z-index: -1; 
        }

        .arrow-display {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .arrow {
            font-size: 100px; 
            transition: transform 0.1s ease;
            margin-bottom: 10px;
            color: red;
            font-weight: bold;
        }

        .distance {
            font-size: 24px;
            background: #fff;
            padding: 10px 20px;
            border-radius: 5px;
            border: 1px solid #ccc;
            margin-bottom: 20px;
        }

        /* Small debug panel at bottom-right corner */
        .debug-panel {
            font-size: 12px;
            background: rgba(0,0,0,0.5);
            color: #fff;
            padding: 5px 10px;
            border-radius: 5px;
            position: absolute;
            bottom: 10px;
            right: 10px;
            max-width: 200px;
        }

        .debug-panel p {
            margin: 3px 0;
        }

        .debug-panel span {
            font-weight: bold;
        }
    </style>
</head>
<body>

    <video id="camera-stream" playsinline autoplay muted></video>
    <div class="overlay"></div>

    <div class="arrow-display">
        <div class="arrow" id="arrow">↑</div>
        <div class="distance" id="distance">Calculating distance...</div>
    </div>

    <div class="debug-panel" id="debug-panel">
        <p>User Lat: <span id="user-lat">N/A</span></p>
        <p>User Lon: <span id="user-lon">N/A</span></p>
        <p>Target Lat: <span id="target-lat">28.334492</span></p>
        <p>Target Lon: <span id="target-lon">-81.517770</span></p>
        <p>Bearing: <span id="bearing">N/A</span>°</p>
        <p>Heading: <span id="device-heading">N/A</span>°</p>
        <p>Rotation: <span id="arrow-rotation">N/A</span>°</p>
        <p>Dist: <span id="debug-distance">N/A</span> ft</p>
    </div>
    

    <script>
        // Target coordinates in decimal degrees
        const targetLat = 28.334492; 
        const targetLon = -81.517770; 

        let currentLat = null;
        let currentLon = null;
        let deviceHeading = 0; // Represent device's heading from North

        const arrow = document.getElementById('arrow');
        const distanceDiv = document.getElementById('distance');
        const debugPanel = {
            userLat: document.getElementById('user-lat'),
            userLon: document.getElementById('user-lon'),
            bearing: document.getElementById('bearing'),
            deviceHeading: document.getElementById('device-heading'),
            arrowRotation: document.getElementById('arrow-rotation'),
            debugDistance: document.getElementById('debug-distance')
        };

        function toRad(deg) {
            return deg * Math.PI / 180;
        }

        function haversineDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; // Earth radius in meters
            const φ1 = toRad(lat1);
            const φ2 = toRad(lat2);
            const Δφ = toRad(lat2 - lat1);
            const Δλ = toRad(lon2 - lon1);

            const a = Math.sin(Δφ / 2) * Math.sin(Δφ / 2) +
                      Math.cos(φ1) * Math.cos(φ2) *
                      Math.sin(Δλ / 2) * Math.sin(Δλ / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

            const distance = R * c; // meters
            return distance;
        }

        function bearingToTarget(lat1, lon1, lat2, lon2) {
            const φ1 = toRad(lat1);
            const φ2 = toRad(lat2);
            const λ1 = toRad(lon1);
            const λ2 = toRad(lon2);

            const y = Math.sin(λ2 - λ1) * Math.cos(φ2);
            const x = Math.cos(φ1)*Math.sin(φ2) -
                      Math.sin(φ1)*Math.cos(φ2)*Math.cos(λ2 - λ1);
            const θ = Math.atan2(y, x);
            let bearing = (θ * 180 / Math.PI + 360) % 360; 
            return bearing;
        }

        function updateDisplay() {
            if (currentLat == null || currentLon == null) {
                return; // No location yet
            }

            const bearing = bearingToTarget(currentLat, currentLon, targetLat, targetLon);
            const distanceMeters = haversineDistance(currentLat, currentLon, targetLat, targetLon);
            const distanceFeet = distanceMeters * 3.28084;
            
            let arrowRotation = bearing - deviceHeading;
            arrowRotation = (arrowRotation + 360) % 360;

            arrow.style.transform = `rotate(${arrowRotation}deg)`;
            distanceDiv.textContent = `${distanceFeet.toFixed(0)} ft away`;

            // Update debug panel
            debugPanel.userLat.textContent = currentLat.toFixed(5);
            debugPanel.userLon.textContent = currentLon.toFixed(5);
            debugPanel.bearing.textContent = bearing.toFixed(2);
            debugPanel.deviceHeading.textContent = deviceHeading.toFixed(2);
            debugPanel.arrowRotation.textContent = arrowRotation.toFixed(2);
            debugPanel.debugDistance.textContent = distanceFeet.toFixed(0);
        }

        // Geolocation
        if ('geolocation' in navigator) {
            navigator.geolocation.watchPosition(position => {
                currentLat = position.coords.latitude;
                currentLon = position.coords.longitude;
                updateDisplay();
            }, 
            error => {
                distanceDiv.textContent = "Unable to get location.";
                console.error("Geolocation error:", error);
            },
            {
                enableHighAccuracy: true
            });
        } else {
            distanceDiv.textContent = "Geolocation not supported.";
        }

        // Listen for device orientation events (Original logic)
        // If this worked before, it should work now.
        window.addEventListener('deviceorientation', (e) => {
            if (e.absolute === true || e.webkitCompassHeading !== undefined) {
                if (e.webkitCompassHeading !== undefined) {
                    // iOS Safari gives heading relative to North directly
                    deviceHeading = e.webkitCompassHeading;
                } else {
                    // On other platforms, alpha=0 usually means facing East.
                    // Convert so that 0 = North.
                    // heading = (450 - e.alpha) % 360 makes alpha=0 -> 90 (North)
                    let heading = (450 - e.alpha) % 360;
                    deviceHeading = heading;
                }
                updateDisplay();
            } else {
                // If we can't get absolute heading, no device heading update.
            }
        });

        // Start camera in background
        if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
            navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
            .then(stream => {
                const video = document.getElementById('camera-stream');
                video.srcObject = stream;
            })
            .catch(err => {
                console.warn("Camera not accessible:", err);
            });
        }
    </script>
</body>
</html>