<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>AR Navigational Arrow</title>
    <style>
        html, body {
            margin: 0; 
            padding: 0; 
            height: 100%;
            overflow: hidden;
        }

        body {
            font-family: sans-serif;
            background: #000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: relative;
        }

        #camera-stream {
            position: absolute;
            top: 0; left: 0; 
            width: 100%; 
            height: 100%;
            object-fit: cover;
            z-index: -2;
        }

        .overlay {
            position: absolute;
            top:0; left:0; right:0; bottom:0;
            background: rgba(0,0,0,0.8);
            z-index: -1; 
        }

        .arrow-display {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .arrow {
            font-size: 100px; 
            transition: transform 0.1s ease;
            margin-bottom: 10px;
            color: red;
            font-weight: bold;
        }

        .distance {
            font-size: 24px;
            background: rgba(0,0,0,0.7);
            color: red;
            font-family: monospace;
            padding: 10px 20px;
            border-radius: 5px;
            margin-bottom: 20px;
        }

        .debug-panel {
            font-size: 14px;
            background: #000;
            color: red;
            font-family: monospace;
            padding: 10px;
            border-radius: 5px;
            width: 90%;
            max-width: 400px;
            margin-top: 20px;
            border: 1px solid red;
        }

        .debug-panel p {
            margin: 5px 0;
        }

        .debug-panel span {
            font-weight: bold;
            color: #ff5555;
        }
    </style>
</head>
<body>
    <video id="camera-stream" playsinline autoplay muted></video>
    <div class="overlay"></div>

    <div class="arrow-display">
        <div class="arrow" id="arrow">↑</div>
        <div class="distance" id="distance">Calculating distance...</div>
    </div>

    <div class="debug-panel" id="debug-panel">
        <p>User Lat: <span id="user-lat">N/A</span></p>
        <p>User Lon: <span id="user-lon">N/A</span></p>
        <p>Target Lat: <span id="target-lat">28.334492</span></p>
        <p>Target Lon: <span id="target-lon">-81.517770</span></p>
        <p>Bearing to Target: <span id="bearing">N/A</span>°</p>
        <p>Device Heading: <span id="device-heading">N/A</span>°</p>
        <p>Final Arrow Rotation: <span id="arrow-rotation">N/A</span>°</p>
        <p>Distance: <span id="debug-distance">N/A</span> ft</p>
    </div>

    <script>
        const targetLat = 28.334492; 
        const targetLon = -81.517770; 

        let currentLat = null;
        let currentLon = null;
        let deviceHeading = 0;

        const arrow = document.getElementById('arrow');
        const distanceDiv = document.getElementById('distance');
        const debugPanel = {
            userLat: document.getElementById('user-lat'),
            userLon: document.getElementById('user-lon'),
            bearing: document.getElementById('bearing'),
            deviceHeading: document.getElementById('device-heading'),
            arrowRotation: document.getElementById('arrow-rotation'),
            debugDistance: document.getElementById('debug-distance')
        };

        console.log("Attempting to request device orientation permission if needed...");
        if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
            DeviceOrientationEvent.requestPermission().then(response => {
                console.log("DeviceOrientationEvent.requestPermission() response:", response);
                if (response === 'granted') {
                    startDeviceOrientation();
                } else {
                    console.warn("Device orientation permission not granted. Orientation may not update.");
                }
            }).catch(err => {
                console.error("Error requesting device orientation permission:", err);
            });
        } else {
            console.log("No device orientation permission needed (non-iOS or older iOS). Starting orientation events.");
            startDeviceOrientation();
        }

        // Start camera background
        if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
            navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
            .then(stream => {
                const video = document.getElementById('camera-stream');
                video.srcObject = stream;
            })
            .catch(err => {
                console.warn("Camera not accessible:", err);
            });
        }

        // Geolocation
        if ('geolocation' in navigator) {
            navigator.geolocation.watchPosition(position => {
                currentLat = position.coords.latitude;
                currentLon = position.coords.longitude;
                console.log("Location updated:", currentLat, currentLon);
                updateDisplay();
            }, 
            error => {
                distanceDiv.textContent = "Unable to get location.";
                console.error("Geolocation error:", error);
            },
            {
                enableHighAccuracy: true
            });
        } else {
            distanceDiv.textContent = "Geolocation not supported.";
        }

        function startDeviceOrientation() {
            console.log("Starting device orientation listener...");
            window.addEventListener('deviceorientation', (e) => {
                console.log('Device Orientation Event:', {
                    alpha: e.alpha,
                    beta: e.beta,
                    gamma: e.gamma,
                    webkitCompassHeading: e.webkitCompassHeading,
                    absolute: e.absolute
                });

                if (typeof e.webkitCompassHeading === 'number') {
                    deviceHeading = e.webkitCompassHeading;
                } else if (typeof e.alpha === 'number') {
                    // Try this formula: If alpha=0 means East, then North= (360 - alpha + 90)%360
                    // If alpha=0 (East), (360 - 0 + 90)=450%360=90, which is North.
                    let heading = (360 - e.alpha + 90) % 360;
                    deviceHeading = heading;
                }

                updateDisplay();
            });
        }

        function toRad(deg) {
            return deg * Math.PI / 180;
        }

        function haversineDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; // meters
            const φ1 = toRad(lat1);
            const φ2 = toRad(lat2);
            const Δφ = toRad(lat2 - lat1);
            const Δλ = toRad(lon2 - lon1);

            const a = Math.sin(Δφ / 2) ** 2 +
                      Math.cos(φ1) * Math.cos(φ2) *
                      Math.sin(Δλ / 2) ** 2;
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        function bearingToTarget(lat1, lon1, lat2, lon2) {
            const φ1 = toRad(lat1);
            const φ2 = toRad(lat2);
            const λ1 = toRad(lon1);
            const λ2 = toRad(lon2);

            const y = Math.sin(λ2 - λ1) * Math.cos(φ2);
            const x = Math.cos(φ1)*Math.sin(φ2) -
                      Math.sin(φ1)*Math.cos(φ2)*Math.cos(λ2 - λ1);
            const θ = Math.atan2(y, x);
            return (θ * 180 / Math.PI + 360) % 360; 
        }

        function updateDisplay() {
            if (currentLat == null || currentLon == null) return;

            const bearing = bearingToTarget(currentLat, currentLon, targetLat, targetLon);
            const distanceMeters = haversineDistance(currentLat, currentLon, targetLat, targetLon);
            const distanceFeet = distanceMeters * 3.28084;
            let arrowRotation = (bearing - deviceHeading + 360) % 360;

            arrow.style.transform = `rotate(${arrowRotation}deg)`;
            distanceDiv.textContent = `${distanceFeet.toFixed(0)} ft away`;

            debugPanel.userLat.textContent = currentLat.toFixed(5);
            debugPanel.userLon.textContent = currentLon.toFixed(5);
            debugPanel.bearing.textContent = bearing.toFixed(2);
            debugPanel.deviceHeading.textContent = deviceHeading.toFixed(2);
            debugPanel.arrowRotation.textContent = arrowRotation.toFixed(2);
            debugPanel.debugDistance.textContent = distanceFeet.toFixed(0);

            console.log(`Updated display: Bearing=${bearing.toFixed(2)}, Heading=${deviceHeading.toFixed(2)}, Rotation=${arrowRotation.toFixed(2)}, Dist=${distanceFeet.toFixed(0)}ft`);
        }
    </script>
</body>
</html>